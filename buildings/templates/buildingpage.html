{% extends "sitebase.html" %}
{% block title %}{{ BUILDING_NAME }} Energy Portal{% endblock %}

{% block extra_scriptsCSS_imports %}
<link href="/site-media/anytime/anytimec.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="/site-media/flot/jquery.flot.js"></script>
<script type="text/javascript" src="/site-media/flot/jquery.flot.stack.min.js"></script>
<script type="text/javascript" src="/site-media/flot/jquery.flot.navigate.min.js"></script>
<script type="text/javascript" src="/site-media/flot/jquery.flot.selection.min.js"></script>
<script type="text/javascript" src="/site-media/anytime/anytimec.js"></script>
{% endblock %}

{% block extra_css_inline %}


	.hero-unit {
		padding-top: 20px;
		padding-bottom: 20px;
		padding-right: 20px;
		padding-left: 20px;


	}

	footer {
		 margin-top: 0px; 
	}
{% endblock %}

{% block header_title %}
{{ BUILDING_NAME }} Energy Portal
{% endblock %}
{% block header_subtitle %}
Drag on the graph to zoom in.
{% endblock %}

{% block content_inside %}
<div class="hero-unit" style="min-height:610px;">

			

<p>Live Energy Usage Graph (Default 1 Day): </p> Start Time: <input class="span4" type = "text" id="date2" size=36>&nbsp; &nbsp; &nbsp; &nbsp;  End Time: <input class="span4" type="text" id="date" size=36>&nbsp; &nbsp; &nbsp; &nbsp; <input type = "button" value = "Load/Refresh Data" id="refresh"> 
<br><br>
<div id="graph" ><div style="float:left;position:relative;top:220px;left:-50px;-moz-transform:rotate(270deg);-o-transform:rotate(270deg);-webkit-transform:rotate(270deg);filter:progid:DXImageTransform.Microsoft.BasicImage(rotation=3);-ms-filter:"progid:DXImageTransform.Microsoft.BasicImage(rotation=3);">Energy Usage (kW)</div> <!-- rotated-text code adapted from http://stackoverflow.com/a/4809513 -->
<!-- contains graph generated by flot -->
<div id="placeholder" style = "position:absolute;margin-left:30px;width:850px;height:500px;">
    <div id="loading" style="position:absolute;width:300px;top:200px;left:50%;margin-left:-150px;text-align:center;padding:7px 0 0 0;font:bold 11px Arial, Helvetica, sans-serif;">  
    Loading data, please wait..  
    <img src="/site-media/images/ajax-loader.gif" alt="loading.." />  
    </div>  
</div><div id="bottomtext" style="position:relative;top:510px;left:-30px;text-align:center;">Time</div>
</div>
</div>





<div class="row">
<div class="span8" style="text-align:center;">
<ul class="media-grid">

        <li>
          <a href="{{ PIC_SRC }}">
            <img class="thumbnail" src="{{ PIC }}" alt="">
          </a>
        </li>
              </ul>

<h6><a href="{{ PIC_SRC }}">Image Source</a></h6>
</div>
<div class="span8">
<h2>About {{ BUILDING_NAME }}:</h2> <p>{{ INFO }} </p><br> <br>
<div style="text-align:right;"><a href="{{ STATS_ALTINFO }}" class="btn large primary">More Info >></a></div>


</div>
</div>

<div class="row">
<div class="span8">
<h2>Building Stats:</h2> 
<ul>
<li>SqFT: {{ STATS_SQFT }} </li>
<li>Year Built: {{ STATS_YEAR }} </li>
<li>Available Data Sources: {{ UUID_COUNT }} </li>
</ul>
</div>
<div class="span8">
	<h2>Location:</h2>
	<div class="mapboxdisp" style="padding-top:10px;overflow:hidden;height:{{ desired_height }}px;width:{{ desired_width }}px;"><div style="margin-left:-{{ x_min }}px;margin-top:-{{ y_min }}px;"><img src="/site-media/campusmap.png" /></div></div>
</div>
</div>
<!-- make UUID display collapsable, needs to be implemented in JS now since db uuids were removed -->


{% endblock %}

{% block random_extras %}
<script type="text/javascript">
//time setup
var datefmt = "%W %M %e, %Y %H:%i";
var converter = new AnyTime.Converter( { format: datefmt });
var nowDate = new Date();
$("#date").val(converter.format(nowDate));
var startDate = new Date();
startDate.setTime(nowDate - 86400000);
$("#date2").val(converter.format(startDate));
AnyTime.picker( "date", { format: datefmt, firstDOW: 0 } );
AnyTime.picker( "date2", { format: datefmt, firstDOW: 0 } );
//end time setup

$(document).ready(function() {
	runReqOne();
});

$("#refresh").click(function() {
	runReqOne();
});


function ajaxReqOne(callback) {
	$.ajax({
		async: true,
		type: 'POST',
		url: '/ARDgetData/api/query?',
		data: "select * where Metadata/Location/Campus = 'UCB' and (has Metadata/Location/Campus and (not Metadata/SourceName = 'Campus Historical Meter Data')) and Metadata/Location/Building = '{{ QUERY_ID }}' and (has Properties/UnitofMeasure) and (Metadata/Extra/Phase = 'ABC' and Properties/UnitofMeasure = 'kW' and Metadata/Extra/System = 'total' and not (Path like '%_demand'))",
		success: function(response) {
			callback(response);
		}
	});
}

function runReqOne() {
	
	ajaxReqOne(function(respo){
		output = [];
		for (ind = 0; ind < respo.length; ind++) {
				output.push(respo[ind]["uuid"]);
			}
		runReqTwo(output);
	});
}

function ajaxReqTwo(callback, latest, inputUUID, starttime, endtime, output) {
	$.ajax({ 
			async: true,
			type: 'GET',
			url: "/ARDgetData/api/data/uuid/" + escape(inputUUID) + "?starttime=" + escape(starttime) + "&endtime=" + escape(endtime),
			success: function(resp) {
				callback(resp);
			}
	});
}

function runReqTwo(output) {
	latest = [];
	var converter = new AnyTime.Converter( { format: datefmt });
	var endtime = converter.parse($("#date").val()).getTime();
	var starttime = converter.parse($("#date2").val()).getTime();

	for(x=0; x<output.length; x++){
	ajaxReqTwo(function(resp){
			//this should add stuff to the latest[]
		latest.push(eval(resp));
		//console.log(latest);
		if (output.length==latest.length){
			drawGraph(latest);
		}
	}, latest, output[x], starttime, endtime, output);
	}
}


function drawGraph(inputData){
	
	var data = [];
	for (ind3 = 0; ind3 < inputData.length; ind3++) {
		data.push(inputData[ind3][0]['Readings']);
	}
    
	var options = {
        	series: {
				stack: true,
            	lines: { show: true, fill: 1 }, //fill: 1 essentially "hides" the fact that there are multiple UUIDs
				color: "blue",
        	},
        	legend: { noColumns: 2 },
        	xaxis: { tickDecimals: 0, mode:"time" },
        	selection: { mode: "x" }
    	};

	var placeholder = $("#placeholder");

	placeholder.bind("plotselected", function (event, ranges) {
		$("#selection").text(ranges.xaxis.from.toFixed(1) + " to " + ranges.xaxis.to.toFixed(1));
		plot = $.plot(placeholder, data, $.extend(true, {}, options, { xaxis: { min: ranges.xaxis.from, max: ranges.xaxis.to } }));
	});

	placeholder.bind("plotunselected", function (event) {
		$("#selection").text("");
	});
	$("#loading").hide()
	var plot = $.plot(placeholder, data, options);
}
</script>
{% endblock %}
