{% extends "sitebase.html" %}
{% block title %}{{ BUILDING_NAME }} Energy Portal{% endblock %}

{% block extra_scriptsCSS_imports %}
<link href="/site-media/anytime/anytimec.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="/site-media/flot/jquery.flot.js"></script>
<script type="text/javascript" src="/site-media/flot/jquery.flot.stack.min.js"></script>
<script type="text/javascript" src="/site-media/flot/jquery.flot.navigate.min.js"></script>
<script type="text/javascript" src="/site-media/flot/jquery.flot.selection.min.js"></script>
<script type="text/javascript" src="/site-media/anytime/anytimec.js"></script>
<script type="text/javascript" src="/site-media/bootstrap/bootstrap-modal.js"></script>
<link rel="stylesheet" href="/site-media/jgauge/css/jgauge.css" type="text/css" /> <!-- CSS for jGauge styling. -->
<!--[if IE]><script type="text/javascript" language="javascript" src="js/excanvas.min.js"></script><![endif]--> <!-- Extends canvas support to IE. (Possibly buggy, need to look into this.) -->
<script language="javascript" type="text/javascript" src="/site-media/jgauge/js/jQueryRotate.min.js"></script> <!-- jQueryRotate plugin used for needle movement. -->
<script language="javascript" type="text/javascript" src="/site-media/jgauge/js/jgauge-0.3.0.a3.js"></script> <!-- jGauge JavaScript. -->
{% endblock %}

{% block extra_css_inline %}
	.hero-unit {
		padding-top: 20px;
		padding-bottom: 20px;
		padding-right: 20px;
		padding-left: 20px;


	}

	footer {
		 margin-top: 0px; 
	}
{% endblock %}

{% block header_title %}
{{ BUILDING_NAME }} Energy Portal
{% endblock %}
{% block header_subtitle %}
Drag on the graph to zoom in.
{% endblock %}

{% block content_inside %}
<div class="hero-unit" style="min-height:610px;">
<p>Live Power Consumption Graph (Default 1 Day): </p> Start Time: <input class="span4" type = "text" id="date2" size=36>&nbsp; &nbsp; &nbsp; &nbsp;  End Time: <input class="span4" type="text" id="date" size=36>&nbsp; &nbsp; &nbsp; &nbsp; <input type = "button" class="btn primary" value = "Load/Refresh Data" id="refresh"> 
<br><br>
<div id="graph" ><div style="float:left;position:relative;top:220px;left:-50px;-moz-transform:rotate(270deg);-o-transform:rotate(270deg);-webkit-transform:rotate(270deg);filter:progid:DXImageTransform.Microsoft.BasicImage(rotation=3);-ms-filter:"progid:DXImageTransform.Microsoft.BasicImage(rotation=3);">Power Consumption (kW)</div> <!-- rotated-text code adapted from http://stackoverflow.com/a/4809513 -->
<!-- contains graph generated by flot -->
<div id="placeholder" style = "position:absolute;margin-left:30px;width:850px;height:500px;">
    
</div><div id="loading" style="position:absolute;width:300px;top:450px;left:50%;margin-left:-150px;text-align:center;padding:7px 0 0 0;font:bold 11px Arial, Helvetica, sans-serif;">  
    Loading data, please wait..  
    <img src="/site-media/images/ajax-loader.gif" alt="loading.." />  
    </div>  <div id="bottomtext" style="position:relative;top:510px;left:-30px;text-align:center;">Time</div>
</div>
</div>

<div class="row">

<div class="span-one-third">
	<div class="hero-unit" style="min-height:200px;text-align:center;"> <h3><a href="#" rel="popover" title="How is this calculated?" data-placement="above" data-content="Deviation from Baseline is calculated by taking the actual kW usage, subtracting the baseline, and finally dividing this result by the baseline. It is effectively a calculation of error; thus a negative percentage means that the building is using less power than usual, while a positive percentage implies exactly the opposite." style="color:#000000;">Deviation from Baseline</a></h3><div style="width:180px;margin:0 auto;"><div id="kWvsBaseline" class="jgauge" style="width:180px;margin:0 auto;"></div></div></div>
</div>

<div class="span-one-third">
	<div class="hero-unit" style="min-height:200px;text-align:center;"> <h3><a href="#" rel="popover" title="How is this calculated?" data-placement="above" data-content="% of Total Campus (kW) is calculated by taking a building's current power usage and dividing it by the sum of the power usage of all campus buildings for which data is available. It is designed to be compared to the gauge to the right, % of Total Campus (SqFt)." style="color:#000000;">% of Total Campus (kW)</a></h3><div style="width:180px;margin:0 auto;"><div id="gaugeTwo" class="jgauge" style="width:180px;margin:0 auto;"></div></div></div>
</div>
<div class="span-one-third">
	<div class="hero-unit" style="min-height:200px;text-align:center;"> <h3><a href="#" rel="popover" title="How is this calculated?" data-placement="above" data-content="% of Total Campus (SqFt) is calculated by taking a building's square footage and dividing it by the sum of the square footage of all campus buildings for which data is available. It is designed to be compared to the gauge to the left, % of Total Campus (kW)." style="color:#000000;">% of Total Campus (SqFt)</a></h3><div style="width:180px;margin:0 auto;"><div id="gaugeThree" class="jgauge" style="width:180px;margin:0 auto;"></div></div></div>
</div>


</div> <!-- endrow -->



<div class="row">
<div class="span8" style="text-align:center;">
<ul class="media-grid">

        <li>
          <a href="{{ PIC_SRC }}">
            <img class="thumbnail" src="{{ PIC }}" alt="">
          </a>
        </li>
              </ul>

<h6><a href="{{ PIC_SRC }}">Image Source</a></h6>
</div>
<div class="span8">
<h2>About {{ BUILDING_NAME }}:</h2> <p>{{ INFO }} </p><br> <br>
<div style="text-align:right;"><button data-controls-modal="modal-from-dom" data-backdrop="true" data-keyboard="true" class="btn large info">More Info >></button></div>


</div>
</div>

<div class="row">
<div class="span8">
<h2>Building Stats:</h2> 
<h4>
<ul>
<li>Square Footage: {{ STATS_SQFT }} </li>
<li>Year Built: {{ STATS_YEAR }} </li>
<li>Available Data Sources: <span id="UUIDcount"></span> </li>
</ul>
</h4>
</div>
<div class="span8">
	<h2>Location:</h2>
	<div class="mapboxdisp" style="padding-top:10px;overflow:hidden;height:{{ desired_height }}px;width:{{ desired_width }}px;"><div style="margin-left:-{{ x_min }}px;margin-top:-{{ y_min }}px;">

<img src="/site-media/campusmap.png" width="1232" height="1067" style="border:0;" alt="campusmap" usemap="#map" id="image" />
						<map id="map" name="map">
						<!-- coordinates stored in the db were obtained using the following: -->
							<!-- #$-:Image map file created by GIMP Image Map plug-in -->
							<!-- #$-:GIMP Image Map plug-in by Maurits Rijk -->
							<!-- #$-:Please do not edit lines starting with "#$" -->
							<!-- #$VERSION:2.3 -->
							<!-- #$AUTHOR:sagark  -->
						<!-- end cooordinates were obtained -->

						<!-- generates imagemap from coordinates stored in database -->
						
						{% for building in buildings|dictsort:"longname" %}
							<area shape="poly" coords="{{ building.map_coords }}" href="/buildings/{{ building.shortname }}/" alt="{{ building.shortname }}"   />
						{% endfor %}

						</map>


</div>


</div>
</div>
</div>

<div id="modal-from-dom" class="modal hide fade">
	<div class="modal-header">
    	<a href="#" class="close">&times;</a>
        	<h3>You are being directed to an external link.</h3>
    </div>
    <div class="modal-body">
		<p>Although we hope the link to be useful, sites change. Thus, we cannot necessarily endorse the link to which you are being directed: {{ STATS_ALTINFO }}</p>
    </div>
    <div class="modal-footer">
    	<a href="{{ STATS_ALTINFO }}" target="_blank" onClick="$('#modal-from-dom').modal('hide')" class="btn primary">Continue to External Site</a>
        <a onClick="$('#modal-from-dom').modal('hide')" class="btn secondary">Go Back</a>
	</div>
</div>



{% endblock %}

{% block random_extras %}
<script type="text/javascript">
//time setup
var datefmt = "%W %M %e, %Y %H:%i";
var converter = new AnyTime.Converter( { format: datefmt });
var nowDate = new Date();
$("#date").val(converter.format(nowDate));
var startDate = new Date();
startDate.setTime(nowDate - 86400000);
$("#date2").val(converter.format(startDate));
AnyTime.picker( "date", { format: datefmt, firstDOW: 0 } );
AnyTime.picker( "date2", { format: datefmt, firstDOW: 0 } );
//end time setup
//gauge setup
	var kWvsBaselineG = new jGauge(); // Create a new jGauge.
				kWvsBaselineG.id = 'kWvsBaseline'; // Link the new jGauge to the placeholder DIV.
				kWvsBaselineG.autoPrefix = autoPrefix.si; // Use SI prefixing (i.e. 1k = 1000).
				kWvsBaselineG.imagePath = '/site-media/jgauge/img/jgauge_face_taco_transparentMod.png';
				kWvsBaselineG.segmentStart = -225;
				kWvsBaselineG.segmentEnd = 45;
				kWvsBaselineG.width = 170;
				kWvsBaselineG.height = 170;
				kWvsBaselineG.needle.imagePath = '/site-media/jgauge/img/jgauge_needle_taco.png';
				kWvsBaselineG.needle.xOffset = 0;
				kWvsBaselineG.needle.yOffset = 0;
                                kWvsBaselineG.label.yOffset = 55;
                                kWvsBaselineG.label.color = '#FFFFFF';
                                kWvsBaselineG.label.precision = 0; // 0 decimals (whole numbers).
				kWvsBaselineG.label.suffix = '%'; // Make the value label watts.
				kWvsBaselineG.ticks.labelRadius = 45;
                                kWvsBaselineG.ticks.labelColor = '#0ce';
                                kWvsBaselineG.ticks.start = -45;
                                kWvsBaselineG.ticks.end = 45;
                                kWvsBaselineG.ticks.count = 5;
                                kWvsBaselineG.ticks.color = 'rgba(0, 0, 0, 0)';
                                kWvsBaselineG.range.color = 'rgba(0, 0, 0, 0)';
var gaugeTwo = new jGauge(); // Create a new jGauge.
				gaugeTwo.id = 'gaugeTwo'; // Link the new jGauge to the placeholder DIV.
				gaugeTwo.autoPrefix = autoPrefix.si; // Use SI prefixing (i.e. 1k = 1000).
				gaugeTwo.imagePath = '/site-media/jgauge/img/jgauge_face_taco_transparentMod.png';
				gaugeTwo.segmentStart = -225;
				gaugeTwo.segmentEnd = 45;
				gaugeTwo.width = 170;
				gaugeTwo.height = 170;
				gaugeTwo.needle.imagePath = '/site-media/jgauge/img/jgauge_needle_taco.png';
				gaugeTwo.needle.xOffset = 0;
				gaugeTwo.needle.yOffset = 0;
                                gaugeTwo.label.yOffset = 55;
                                gaugeTwo.label.color = '#FFFFFF';
                                gaugeTwo.label.precision = 0; // 0 decimals (whole numbers).
				gaugeTwo.label.suffix = '%'; // Make the value label watts.
				gaugeTwo.ticks.labelRadius = 45;
                                gaugeTwo.ticks.labelColor = '#0ce';
                                gaugeTwo.ticks.start = 0;
                                gaugeTwo.ticks.end = 10;
                                gaugeTwo.ticks.count = 5;
                                gaugeTwo.ticks.color = 'rgba(0, 0, 0, 0)';
                                gaugeTwo.range.color = 'rgba(0, 0, 0, 0)';
var gaugeThree = new jGauge(); // Create a new jGauge.
				gaugeThree.id = 'gaugeThree'; // Link the new jGauge to the placeholder DIV.
				gaugeThree.autoPrefix = autoPrefix.si; // Use SI prefixing (i.e. 1k = 1000).
				gaugeThree.imagePath = '/site-media/jgauge/img/jgauge_face_taco_transparentMod.png';
				gaugeThree.segmentStart = -225;
				gaugeThree.segmentEnd = 45;
				gaugeThree.width = 170;
				gaugeThree.height = 170;
				gaugeThree.needle.imagePath = '/site-media/jgauge/img/jgauge_needle_taco.png';
				gaugeThree.needle.xOffset = 0;
				gaugeThree.needle.yOffset = 0;
                                gaugeThree.label.yOffset = 55;
                                gaugeThree.label.color = '#FFFFFF';
                                gaugeThree.label.precision = 0; // 0 decimals (whole numbers).
				gaugeThree.label.suffix = '%'; // Make the value label watts.
				gaugeThree.ticks.labelRadius = 45;
                                gaugeThree.ticks.labelColor = '#0ce';
                                gaugeThree.ticks.start = 0;
                                gaugeThree.ticks.end = 10;
                                gaugeThree.ticks.count = 5;
                                gaugeThree.ticks.color = 'rgba(0, 0, 0, 0)';
                                gaugeThree.range.color = 'rgba(0, 0, 0, 0)';
//end gauge setup

$(function () {
              $("a[rel=popover]")
                .popover({
                  offset: 10
                })
                .click(function(e) {
                  e.preventDefault()
                })
            })

$(document).ready(function() {
	runReqOne();
	kWvsBaselineG.init();
	gaugeTwo.init();
	gaugeThree.init();
	kWvsBaselineG.setValue(000);
	gaugeTwo.setValue(000);
	gaugeThree.setValue(000);
});

$("#refresh").click(function() {
	$("#placeholder").empty();
	$("#loading").show();
	runReqOne();
});


function ajaxReqOne(callback) {
	$.ajax({
		async: true,
		type: 'POST',
		url: '/ARDgetData/api/query?',
		data: "select * where Metadata/Location/Building = '{{ QUERY_ID }}' and (Metadata/Extra/Operator like 'baseline-%' or (Metadata/Extra/Operator = 'subsampled sum') or Metadata/PointName = 'SDH.STEAM_FLOW') and not (Metadata/Path like '1-hr') and not (Metadata/Extra/Resample like 'subsample-mean-3600')",
		success: function(response) {
			callback(response);
		}
	});
}

function runReqOne() {
	
	ajaxReqOne(function(respo){
		output = [];
		sendUUIDcount = document.getElementById('UUIDcount');
		sendUUIDcount.innerHTML = respo.length;
		for (ind = 0; ind < respo.length; ind++) {
				output.push([respo[ind]["uuid"],respo[ind]["Metadata"]["Extra"]["Operator"]]);
			}
		runReqTwo(output);
	});
}

function ajaxReqTwo(callback, latest, inputUUID, starttime, endtime, output, typeInput) {
	$.ajax({ 
			async: true,
			type: 'GET',
			url: "/ARDgetData/api/data/uuid/" + escape(inputUUID) + "?starttime=" + escape(starttime) + "&endtime=" + escape(endtime),
			success: function(resp) {
				callback(resp, typeInput);
			}
	});
}

function runReqTwo(output) {
	latest = [];
	typeOrder = [];
	var converter = new AnyTime.Converter( { format: datefmt });
	var endtime = converter.parse($("#date").val()).getTime();
	var starttime = converter.parse($("#date2").val()).getTime();

	for(x=0; x<output.length; x++){
	ajaxReqTwo(function(resp, typeInput){
		typeOrder.push(typeInput);
		latest.push(eval(resp));
		if (output.length==latest.length){
			latest = drawGraph(latest, typeOrder);
			setAllTheGauges(latest[0][0]['Readings'][latest[0][0]['Readings'].length-1], latest[1][0]['Readings'][latest[1][0]['Readings'].length-1]);
		}
	}, latest, output[x][0], starttime, endtime, output, output[x][1]);
	}
}

function setAllTheGauges(lastActualkW, lastActualBaseline) {
	percent = Math.round((lastActualkW[1]-lastActualBaseline[1])/lastActualBaseline[1]*100);
	kWvsBaselineG.setValue(percent);
	callgetLatestWholeCampus(lastActualkW);
	gaugeThree.setValue({{ sqftPercent }});	
}

function callgetLatestWholeCampus(lastActualkW){
	getLatestWholeCampus(setMiddleGauge, lastActualkW);
}

function getLatestWholeCampus(callback, lastActualkW) {
	$.ajax({
		async: true,
		type: 'POST',
		url: '/ARDgetData/api/query?',
		data: "select data before now limit 1 where uuid =\'" + escape("aa0463c1-478e-5a2d-8b0f-2f26c5c5f262") + "'",
		success: function(response) {
			callback(response, lastActualkW);
		}
	});
}

function setMiddleGauge(response, lastActualkW){
	wholecamp = response[0]['Readings'][0][1];
	thisbuildkW = lastActualkW[1];
	gaugeTwo.setValue(thisbuildkW/wholecamp*100);
}

function drawGraph(inputData, typeData){
	if (typeData[0] == "subsampled sum"){
	}
	else {
		inputData = [inputData[1], inputData[0]]; //fixes ordering for passing on 
		typeData = [typeData[1], typeData[0]];
	}
	for (val in typeData){
		if (typeData[val]=="baseline-01"){
			typeData[val] = "Predicted Usage";
		}
		else if (typeData[val] =="subsampled sum"){
			typeData[val] = "Actual Usage";
		}
	}
	//Now fix timezone offset for flot

	needTzOffset = new Date();
	tzOffset = needTzOffset.getTimezoneOffset()*60000
	for (x=0; x<inputData.length; x++){
		for (y=0; y<inputData[x][0]['Readings'].length; y++){
			inputData[x][0]['Readings'][y][0] = inputData[x][0]['Readings'][y][0]-tzOffset;
		}
	}

	//end fix timezone offset for flot
	var data = [];
	for (ind3 = 0; ind3 < inputData.length; ind3++) {
		data.push({label:typeData[ind3], "data":inputData[ind3][0]['Readings']});
	}
	var options = {
			colors: ["blue", "black"],
        	legend: { noColumns: 2 },
        	xaxis: { tickDecimals: 0, mode:"time" },
        	selection: { mode: "x" }
    	};

	var placeholder = $("#placeholder");

	placeholder.bind("plotselected", function (event, ranges) {
		$("#selection").text(ranges.xaxis.from.toFixed(1) + " to " + ranges.xaxis.to.toFixed(1));
		plot = $.plot(placeholder, data, $.extend(true, {}, options, { xaxis: { min: ranges.xaxis.from, max: ranges.xaxis.to } }));
	});

	placeholder.bind("plotunselected", function (event) {
		$("#selection").text("");
	});
	$("#loading").hide()
	var plot = $.plot(placeholder, data, options);
	return inputData;
}
</script>
{% endblock %}
